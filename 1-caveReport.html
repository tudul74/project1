<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <title>ë™êµ´ë¯¸ì…˜ ë¦¬í¬íŠ¸</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://raw.githack.com/eKoopmans/html2pdf/master/dist/html2pdf.bundle.js"></script>
  <style>
    body {
      padding: 10px;
      background: #fffaf2;
      font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
      color: #333;
    }

    .report-container {
      max-width: 780px;
      padding: 24px 32px;
      background: white;
      border-radius: 15px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
      margin: auto;
    }

    .report-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .report-header h1 {
      font-size: 28px;
      color: #2c7c8c;
      margin-bottom: 16px;
    }

    .report-meta {
      display: flex;
      justify-content: center;
      gap: 32px;
      flex-wrap: wrap;
      font-size: 18px;
      color: #444;
    }

    .summary-box {
      background: #f0f9f9;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 30px;
    }

    .summary-box p {
      display: flex;
      align-items: baseline;
      gap: 8px;
    }

    .section-title {
      font-size: 20px;
      font-weight: bold;
      margin-top: 30px;
      color: #397d84;
      border-bottom: 2px solid #c4e4e4;
      padding-bottom: 5px;
    }

    .footer {
      text-align: center;
      margin-top: 40px;
      font-style: italic;
      color: #666;
    }

    .stars {
      color: #f7c94c;
      font-weight: bold;
      margin-top: 2px;
    }

    .chart-container {
      position: relative;
    }

    .chart-overlay {
      position: absolute;
      pointer-events: none;
    }

    .icon-label {
      position: absolute;
      font-size: 14px;
      text-align: center;
      transform: translate(-50%, -50%);
      pointer-events: none;
      white-space: nowrap;
    }

    .chest-topic-list {
      margin-top: 20px;
      padding-left: 20px;
      font-size: 15px;
      line-height: 1.6;
      color: #444;
    }

    .chest-topic-list li::before {
      content: 'ğŸ“¦ ';
    }
  </style>
</head>

<body>

  <div id="report" class="report-container">
    <div class="report-header">
      <h1>ì œ1ì¥ ë™êµ´ë¯¸ì…˜ í•™ìŠµ ë³´ê³ ì„œ</h1>
      <div class="report-meta" id="metaArea">
        <!-- ìë™ ì‚½ì… -->
      </div>
    </div>

    <div class="summary-box" id="summaryBox">
      <!-- ìë™ ì‚½ì… -->
    </div>

    <div class="section-title">ë³´ë¬¼ìƒìë³„ ì •í™•ë„ + ë³„ ê°œìˆ˜</div>
    <div class="chart-container">
      <canvas id="accuracyChart" width="700" height="300"></canvas>
      <div id="chartOverlay" class="chart-overlay"></div>
    </div>

    <div class="section-title">ë³´ë¬¼ìƒìë³„ í•™ìŠµ ì£¼ì œ</div>
    <ul class="chest-topic-list">
      <li><strong>1ë²ˆ ë³´ë¬¼ìƒì:</strong> ê° ì•Œì•„ë³´ê¸°</li>
      <li><strong>2ë²ˆ ë³´ë¬¼ìƒì:</strong> ê° ê·¸ë¦¬ê¸°</li>
      <li><strong>3ë²ˆ ë³´ë¬¼ìƒì:</strong> ì§ê°ì‚¼ê°í˜•ì—ì„œ ì§ê° ì°¾ê¸°</li>
      <li><strong>4ë²ˆ ë³´ë¬¼ìƒì:</strong> ì§ê°ì‚¼ê°í˜• ê·¸ë¦¬ê¸°</li>
      <li><strong>5ë²ˆ ë³´ë¬¼ìƒì:</strong> ì§ê°ì‚¬ê°í˜•ì—ì„œ ì§ê° ì°¾ê¸°</li>
      <li><strong>6ë²ˆ ë³´ë¬¼ìƒì:</strong> ì§ê°ì‚¬ê°í˜• ê·¸ë¦¬ê¸°</li>
    </ul>

    <div class="footer">
      "ë„Œ ì´ì œ ìˆ²ì† ë§ˆì„ë¡œ ê°ˆ ì¤€ë¹„ê°€ ë˜ì—ˆë‹¤."
    </div>
  </div>

  <script>
    function decodeData() {
      const raw = new URLSearchParams(location.search).get("data");
      if (!raw) return null;

      try {
        const json = decodeURIComponent(raw);
        return JSON.parse(json);
      } catch (e) {
        console.error("JSON ë””ì½”ë”© ì˜¤ë¥˜:", e);
        return null;
      }
    }

    const report = decodeData();
    if (!report) {
      document.getElementById("report").innerHTML = `<p>â— ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>`;
      throw new Error("Invalid report data");
    }

    const name = report.name || 'ì´ë¦„ì—†ìŒ';
    const corrects = report.corrects || [0, 0, 0, 0, , 0];
    const wrongs = report.wrongs || [0, 0, 0, 0, 0, 0];
    const stars = corrects.reduce((sum, c) => sum + c, 0);
    const total = corrects.map((c, i) => c + wrongs[i]);
    const totalCorrect = corrects.reduce((sum, v) => sum + v, 0);
    const totalQuestions = total.reduce((a, b) => a + b, 0);
    const accuracy = totalQuestions ? (totalCorrect / totalQuestions) * 100 : 0;

    // ë©”íƒ€ ì˜ì—­
    document.getElementById('metaArea').innerHTML = `
    <div><strong>ì´ë¦„:</strong> ${name}</div>
    <div><strong>ì´ ë³„ ê°œìˆ˜:</strong> <span class="stars">â­ x ${stars}</span></div>
    <div><strong>ë‚ ì§œ:</strong> ${new Date().toLocaleDateString()}</div>
  `;

    function generateFeedback(accuracy, wrongCount) {
      if (accuracy >= 95) {
        return "ì™„ë²½í•´ìš”! ì§ê°ê³¼ ê°ë„ ê°œë…ì„ ì•„ì£¼ ì˜ ì´í•´í–ˆì–´ìš”! ğŸ‘";
      } else if (accuracy >= 80) {
        return "ì§ê°ê³¼ ê°ë„ ê°œë…ì„ ì˜ ìµí˜”ì–´ìš”! ì •êµí•¨ì´ ì¡°ê¸ˆ ë” ì¢‹ì•„ì§ˆ ìˆ˜ ìˆì–´ìš”!";
      } else if (accuracy >= 60) {
        return "ê¸°ë³¸ ê°œë…ì€ ì˜ ì´í•´í–ˆì–´ìš”. ë³µìŠµì„ ì¡°ê¸ˆ ë” í•´ë³¼ê¹Œìš”? ğŸ’¡";
      } else {
        return "ì¡°ê¸ˆ ë” ì—°ìŠµì´ í•„ìš”í•´ìš”! ê°ë„ì™€ ì§ê°ì„ ë‹¤ì‹œ ê³µë¶€í•´ë´ìš”! ğŸ”";
      }
    }

    // ìš”ì•½ ë°•ìŠ¤
    const feedback = generateFeedback(accuracy, wrongs.reduce((a, b) => a + b, 0));

    document.getElementById('summaryBox').innerHTML = `
  <p>ğŸ“¦ <strong>ì´ ë¯¸ì…˜ ìˆ˜:</strong> ${corrects.length}ê°œ ë³´ë¬¼ìƒì</p>
  <p>ğŸ“ <strong>ì´ ë¬¸ì œ ìˆ˜:</strong> ${totalQuestions}ë¬¸ì œ</p>
  <p>âœ… <strong>ì •ë‹µ ìˆ˜:</strong> ${totalCorrect}ê°œ</p>
  <p>ğŸ“Š <strong>í‰ê·  ì •í™•ë„:</strong> ${accuracy.toFixed(1)}%</p>
  <p>ğŸ’¬ <strong>í•œì¤„ í”¼ë“œë°±:</strong> ${feedback}</p>
`;

    // ì°¨íŠ¸ ê·¸ë¦¬ê¸°
    const labels = corrects.map((_, i) => `${i + 1}ë²ˆ ë³´ë¬¼ìƒì`);
    const accuracyData = corrects.map((c, i) => {
      const total = c + (wrongs[i] || 0);
      return total > 0 ? (c / total) * 100 : 0;
    });
    const ctx = document.getElementById('accuracyChart').getContext('2d');
    const chartOverlay = document.getElementById('chartOverlay');

    const chart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'ì •í™•ë„ (%)',
          data: accuracyData,
          backgroundColor: '#2c7c8c'
        }]
      },
      options: {
        responsive: false,
        animation: {
          onComplete: () => {
            chartOverlay.innerHTML = '';
            corrects.forEach((v, i) => {
              const meta = chart.getDatasetMeta(0).data[i];
              const x = meta.x;
              const y = chart.scales.y.top - 5;
              const div = document.createElement('div');
              div.className = 'icon-label';
              div.style.left = `${x}px`;
              div.style.top = `${y}px`;
              div.textContent = `â­ x ${v}`;
              chartOverlay.appendChild(div);
            });
          }
        },
        scales: {
          y: { beginAtZero: true, max: 100 }
        },
        plugins: {
          legend: { display: false }
        }
      }
    });

    // PDF ìë™ ì €ì¥
    window.onload = () => {
      setTimeout(() => {
        const element = document.getElementById('report');
        html2pdf().set({
          margin: 0.5,
          filename: 'ë™êµ´ë¯¸ì…˜_ë¦¬í¬íŠ¸.pdf',
          html2canvas: { scale: 2 },
          jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
        }).from(element).save();
      }, 300);
    };
  </script>


</body>

</html>
