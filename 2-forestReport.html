<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <title>ë™êµ´ë¯¸ì…˜ ë¦¬í¬íŠ¸</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://raw.githack.com/eKoopmans/html2pdf/master/dist/html2pdf.bundle.js"></script>
  <style>
    body {
      padding: 10px;
      background: #fffaf2;
      font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
      color: #333;
    }

    .report-container {
      max-width: 700px;
      padding: 0px 16px;
      background: white;
      border-radius: 15px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
      margin: auto;
    }

    .report-header {
      text-align: center;
      margin-bottom: 15px;
    }

    .report-header h1 {
      font-size: 28px;
      color: #2c7c8c;
      margin-bottom: 15px;
    }

    .report-meta {
      display: flex;
      justify-content: center;
      gap: 32px;
      flex-wrap: wrap;
      font-size: 18px;
      color: #444;
    }

    .summary-box {
      background: #f0f9f9;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
    }

    .summary-box p {
      display: flex;
      align-items: baseline;
      gap: 8px;
    }

    .section-title {
      font-size: 20px;
      font-weight: bold;
      margin-top: 30px;
      color: #397d84;
      border-bottom: 2px solid #c4e4e4;
      padding-bottom: 5px;
    }

    .footer {
      text-align: center;
      margin-top: 40px;
      font-style: italic;
      color: #666;
    }

    .stars {
      color: #f7c94c;
      font-weight: bold;
      margin-top: 2px;
    }

    .chart-container {
      position: relative;
    }

    .chart-overlay {
      position: absolute;
      pointer-events: none;
    }

    .icon-label {
      position: absolute;
      font-size: 14px;
      text-align: center;
      transform: translate(-50%, -50%);
      pointer-events: none;
      white-space: nowrap;
    }

    .hills-topic-list,
    .monkey-feedback-text {
      list-style: none;
      padding-left: 0;
      margin: 0;
    }

    .monkey-feedback-area-bg {
      position: relative;
      margin-top: 20px;
      min-height: 180px;
    }

    .monkey-feedback-bg {
      width: 700px;
      height: auto;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
    }

    .monkey-feedback-text {
      margin-left: 260px;
      z-index: 2;
      position: relative;
      font-size: 15px;
      line-height: 1.7;
    }
  </style>
</head>

<body>
  <div id="loading">ğŸ“Š ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
  <div id="report" class="report-container" style="display: none;">
    <div class="report-header">
      <h1>ì œ2ì¥ ìˆ²ì†ë§ˆì„ í•™ìŠµ ë³´ê³ ì„œ</h1>
      <div class="report-meta" id="metaArea"></div>
    </div>
    <div class="summary-box" id="summaryBox"></div>
    <div class="section-title">ì–¸ë•ë³„ ê°ë„ëª½ í”¼ë“œë°±</div>
    <div class="monkey-feedback-area-bg">
      <div class="monkey-container">
        <img src="https://raw.githubusercontent.com/tudul74/project1/main/images/feedbackBG.png"
          class="monkey-feedback-bg" alt="ê°ë„ëª½ ë°°ê²½">
        <ul id="hillFeedbackList" class="hills-topic-list monkey-feedback-text"></ul>
      </div>
    </div>
    <div class="section-title">ë³´ë¬¼ìƒìë³„ ì •í™•ë„ + ë³„ ê°œìˆ˜</div>
    <div class="chart-container">
      <canvas id="accuracyChart" width="700" height="300"></canvas>
      <div id="chartOverlay" class="chart-overlay"></div>
    </div>
    <div class="section-title">ì–¸ë•ë³„ í•™ìŠµ ì£¼ì œ</div>
    <ul class="hills-topic-list">
      <li><strong>ê°ë¹› ì–¸ë•:</strong> ê°ì˜ í¬ê¸° ë¹„êµí•˜ê¸°</li>
      <li><strong>ê°ì • ì–¸ë•:</strong> ê°ë„ê¸°ë¡œ ê°ì˜ í¬ê¸° ì¬ê¸°</li>
      <li><strong>í˜•íƒœ ì–¸ë•:</strong> ì˜ˆê°, ë‘”ê°</li>
      <li><strong>ê°ê° ì–¸ë•:</strong> ê°ë„ ì–´ë¦¼í•˜ê¸°</li>
      <li><strong>ì¡°í™” ì–¸ë•:</strong> ê°ë„ì˜ í•©ê³¼ ì°¨</li>
      <li><strong>ì™„ì„± ì–¸ë•:</strong> ì‚¼ê°í˜• ì„¸ ê°ì˜ í¬ê¸°ì˜ í•©</li>
      <li><strong>ë„¤ì ì–¸ë•:</strong> ì‚¬ê°í˜• ë„¤ ê°ì˜ í¬ê¸°ì˜ í•©</li>
    </ul>
    <div class="footer">
      ì´ ë¦¬í¬íŠ¸ëŠ” ì—¬ëŸ¬ë¶„ì˜ í•™ìŠµ ê²°ê³¼ë¥¼ ìš”ì•½í•œ ê²ƒì…ë‹ˆë‹¤. ì•ìœ¼ë¡œë„ ì—´ì‹¬íˆ ê³µë¶€í•˜ì„¸ìš”! ğŸ˜Š
    </div>
  </div>
  <!-- ì €ì¥ ë²„íŠ¼ -->
  <div id="saveBtnWrapper" style="display:none; text-align:center; margin-top: 20px;">
    <button id="savePDFBtn"
      style="padding: 10px 20px; font-size: 16px; background-color: #2c7c8c; color: white; border: none; border-radius: 8px; cursor: pointer;">
      ğŸ“„ PDF ì €ì¥í•˜ê¸°
    </button>
  </div>
  <script>
    const googleSheet = "https://script.google.com/macros/s/AKfycbzVXOb6MxMAVqOnxVg1-MRSHHygnb1taXbMciOxTI0GCoL65RRM4Fv2uwEcVneXHZENjw/exec";
    const playerID = new URLSearchParams(location.search).get("playerID") || "2eK1Xn";

    let userName = "";

    fetch(`${googleSheet}?playerID=${playerID}&type=report`)
      .then(res => res.json())
      .then(data => {
        const name = data.name;
        userName = name;
        const corrects = data.corrects;
        const wrongs = data.wrongs;
        const stars = corrects.reduce((sum, c) => sum + c, 0);
        const total = corrects.map((c, i) => c + wrongs[i]);
        const totalCorrect = corrects.reduce((sum, v) => sum + v, 0);
        const totalQuestions = total.reduce((a, b) => a + b, 0);
        const accuracy = totalQuestions ? (totalCorrect / totalQuestions) * 100 : 0;

        document.getElementById('metaArea').innerHTML = `
          <div><strong>ì´ë¦„:</strong> ${name}</div>
          <div><strong>ì´ ë³„ ê°œìˆ˜:</strong> <span class="stars">â­ x ${stars}</span></div>
          <div><strong>ë‚ ì§œ:</strong> ${new Date().toLocaleDateString()}</div>`;

        const feedback = accuracy >= 95 ? "ì™„ë²½í•´ìš”! ë‹¹ì‹ ì€ ì´ì œ ê°ë„ ë§ˆìŠ¤í„°ì…ë‹ˆë‹¤. ë§ˆë²•ì‚¬ ë£¨ë¯¸ë‚˜ì—ê²Œ ê°€ì„¸ìš”. ğŸ‘" :
          accuracy >= 80 ? "ê°ë„ ë§ˆìŠ¤í„°ê°€ ë˜ê¸° ì¶©ë¶„í•´ìš”! ì •êµí•¨ì´ ì¡°ê¸ˆ ë” ì¢‹ì•„ì§ˆ ìˆ˜ ìˆì–´ìš”!" :
            accuracy >= 60 ? "ê¸°ë³¸ ê°œë…ì€ ì˜ ì´í•´í–ˆì–´ìš”. ë³µìŠµì„ ì¡°ê¸ˆ ë” í•´ë³¼ê¹Œìš”? ğŸ’¡" :
              "ì¡°ê¸ˆ ë” ì—°ìŠµì´ í•„ìš”í•´ìš”! ë¶€ì¡±í•œ ì–¸ë•ì— ê°€ì„œ ë‹¤ì‹œ ê³µë¶€í•´ë´ìš”! ğŸ”";

        const hillInfos = [
          { name: "ê°ë¹› ì–¸ë•", type: "lower-is-better" },
          { name: "ê°ì • ì–¸ë•", type: "lower-is-better" },
          { name: "í˜•íƒœ ì–¸ë•", type: "higher-is-better" },
          { name: "ê°ê° ì–¸ë•", type: "higher-is-better" },
          { name: "ì¡°í™” ì–¸ë•", type: "higher-is-better" },
          { name: "ì™„ì„± ì–¸ë•", type: "higher-is-better" },
          { name: "ë„¤ì ì–¸ë•", type: "higher-is-better" }
        ];

        function getHillFeedback(accuracy, type) {
          if (type === "lower-is-better") {
            return accuracy >= 95 ? "ë¹ ë¥´ê³  ì •í™•í•˜ê²Œ í•´ê²°í–ˆì–´ìš”! ğŸ’¨" :
              accuracy >= 80 ? "ì¢‹ì•„ìš”! ì‹œê°„ ë‹¨ì¶•ì„ ì¡°ê¸ˆ ë” í•´ë³´ì„¸ìš”!" :
                "ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë ¸ì–´ìš”. ë” ì—°ìŠµí•´ë´ìš”! â³";
          } else {
            return accuracy >= 90 ? "ì •í™•ë„ê°€ ì•„ì£¼ ë†’ì•„ìš”! í›Œë¥­í•´ìš”! ğŸ¯" :
              accuracy >= 70 ? "ê¸°ë³¸ì€ ì˜ í–ˆì–´ìš”! ì¡°ê¸ˆ ë” ì—°ìŠµí•´ë´ìš”!" :
                "ì¡°ê¸ˆ ë” ì—°ìŠµí•˜ë©´ ë” ë‚˜ì•„ì§ˆ ìˆ˜ ìˆì–´ìš”! ğŸ”„";
          }
        }

        let completedCount = 0;
        let feedbackHTML = "";

        hillInfos.forEach((hill, i) => {
          const total = (corrects[i] || 0) + (wrongs[i] || 0);
          if (total > 0) {
            completedCount++;
            const acc = (corrects[i] / total) * 100;
            const feedback = getHillFeedback(acc, hill.type);
            feedbackHTML += `<li>â›°ï¸ <strong>${hill.name}</strong>: ${feedback} (ì •í™•ë„ ${acc.toFixed(1)}%)</li>`;
          } else {
            feedbackHTML += `<li>â›°ï¸ <strong>${hill.name}</strong>:<em style="color:green"> ì•„ì§ ë„ì „í•˜ì§€ ì•Šì•˜ì–´ìš”! í¬ê¸°í•˜ì§€ ë§ˆì„¸ìš”.</em></li>`;
          }
        });

        let goNext = "";
        if (completedCount === 7) goNext = `${completedCount}ê°œ ì–¸ë•ì„ ëª¨ë‘ í•´ê²°í–ˆìŠµë‹ˆë‹¤. ë§ˆë²•ì‚¬ ë£¨ë¯¸ë‚˜ì—ê²Œ ê°€ì„¸ìš”.`;
        else goNext = `${completedCount}ê°œ ì–¸ë•ì„ í•´ê²°í–ˆìŠµë‹ˆë‹¤. í•´ê²°í•˜ì§€ ëª»í•œ ì–¸ë•ì— ê°€ì„œ ë„ì „í•´ë´ìš”!`;

        document.getElementById('summaryBox').innerHTML = `
          <p>ğŸ“¦ <strong>ì™„ë£Œ ë¯¸ì…˜:</strong> ${goNext}</p>
          <p>ğŸ“ <strong>ë¬¸ì œ í•´ê²°:</strong> ${totalQuestions}ë¬¸ì œ</p>
          <p>âœ… <strong>ì •ë‹µ ì œì¶œ:</strong> ${totalCorrect}ê°œ</p>
          <p>ğŸ“Š <strong>í‰ê·  ì •í™•ë„:</strong> ${accuracy.toFixed(1)}%</p>
          <p>ğŸ’¬ <strong>í•œì¤„ í”¼ë“œë°±:</strong> ${feedback}</p>`;

        const percent = Math.floor((completedCount / hillInfos.length) * 100);
        feedbackHTML = `<li><strong>ğŸ“Š ì–¸ë• ë„ì „ë¥ :</strong> ${percent}%</li>` + feedbackHTML;
        document.getElementById("hillFeedbackList").innerHTML = feedbackHTML;

        const ctx = document.getElementById('accuracyChart').getContext('2d');
        const chartOverlay = document.getElementById('chartOverlay');
        const accuracyData = corrects.map((c, i) => {
          const total = c + (wrongs[i] || 0);
          return total > 0 ? (c / total) * 100 : 0;
        });

        const chart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: hillInfos.map(h => h.name),
            datasets: [{
              label: 'ì •í™•ë„ (%)',
              data: accuracyData,
              backgroundColor: '#2c7c8c'
            }]
          },
          options: {
            responsive: false,
            animation: {
              onComplete: () => {
                chartOverlay.innerHTML = '';
                corrects.forEach((v, i) => {
                  const meta = chart.getDatasetMeta(0).data[i];
                  const x = meta.x;
                  const y = chart.scales.y.top - 5;
                  const div = document.createElement('div');
                  div.className = 'icon-label';
                  div.style.left = `${x}px`;
                  div.style.top = `${y}px`;
                  div.textContent = `â­ x ${v}`;
                  chartOverlay.appendChild(div);
                });

                document.getElementById("saveBtnWrapper").style.display = "block";
              }
            },
            scales: { y: { beginAtZero: true, max: 100 } },
            plugins: { legend: { display: false } }
          }
        });

        document.getElementById("loading").style.display = "none";
        document.getElementById("report").style.display = "block";
      })
      .catch(err => {
        console.error(err);
        document.getElementById("report").innerHTML = `<p>â— ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>`;
      });

    document.getElementById("savePDFBtn").addEventListener("click", () => {
      const element = document.getElementById('report');
      html2pdf().set({
        margin: [0.2, 0.2, 0.5, 0.2],
        filename: `ë™êµ´ë¯¸ì…˜_ë¦¬í¬íŠ¸(${userName}).pdf`,
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
      }).from(element).save();
    });

  </script>
</body>

</html>